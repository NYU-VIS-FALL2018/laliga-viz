<html>
<head>
	<title>40 Years of Competitive History in La Liga</title>

	<link href='https://fonts.googleapis.com/css?family=Anton' rel='stylesheet'>
	<link href='https://fonts.googleapis.com/css?family=Arimo' rel='stylesheet'>

	<script src="https://d3js.org/d3.v4.min.js"></script>

	<style>
	body {
		background-color: ghostwhite;

	}
	.banner {
		width: 100%;
		height: 50%;
		background-image: url("bg.png");
		background-color: #5596e6;
		background-position: center;
		background-repeat: no-repeat;
		background-size: cover;
		background-attachment: fixed;
	}
	.banner_mid {
		width: 100%;
		height: 25%;
		background-image: url("bg2.png");
		background-color: #5596e6;
		background-position: center;
		background-repeat: no-repeat;
		background-size: cover;
		background-attachment: fixed;
	}
	.page {
		overflow: auto;
		display: flex;
		flex-direction: column;
		flex-wrap: wrap;
	}
	.main {
		padding: 0.5%;
		float: left;
	}
	.main h2 {
		font-family: 'Arimo';
	}

	.left {
		padding: 1%;
		width: 60%;
	}
	.right {
		padding: 1%;
		width: 40%;
	}
	.data-circle {
	fill: red;
	}
	.data-line {
	  fill: none;
	  stroke: #3C92BA;
	  stroke-width: 8px;
	}
	.line-circle{
		fill:none;
	}

	/* Clear floats after the columns */
	.row:after {
	    content: "";
	    display: table;
	    clear: both;
	}
	.header {
		font-family: 'Anton'; font-size: 60px; color: #152935;
	}
	.subheader {
		font-family: 'Arimo'; font-size: 20px; color: #5a6872; font-style: italic;
	}
	.authors {
		font-family: 'Arimo'; font-size: 14px; color: #5a6872;
	}

	.fill {
		background-color: black;
	}
	ul, li, p {
		font-family: 'Arimo'; font-size: 16px; color: #152935; line-height: 30px;
	}

	/* Chart */
	.bar {
      fill: #30588c;
    }

    .bar:hover {
      fill: #c79aafef;
    }

    .label {
      fill: black;
      font: 12px sans-serif;
    }

	.line{
		fill: none;
		stroke: #3d70b2;
	}
	.dot {
    stroke: #000;
    fill: #3d70b2;
    }
	.ndot51 {
    stroke: #000;
    fill: #81822F;
    }
	
    .dot:hover {
    	fill: #3d70b2;
    }
    .mainView {
    	display: flex;
    }

.tooltip {
	font-family: 'Arimo';
	font-size: 14px;
	padding: 1%;
  position: absolute;
  width: 200px;
  height: 100px;
  pointer-events: none;
  background: lightsteelblue;
  border: 1px;
  border-radius: 5px;
}
.scatterplot{
	
}



	</style>

<link rel="shortcut icon"  href="la_liga.ico" type="image/x-icon" />
</head>

<body>
	<div class='banner'></div>
	<div class='main'>
		<div class='main-left'>
		<h1 class='header'>Competition in the Spain's La Liga</h1>
		<h2 class='subheader'>We follow the money to explain competitiveness in Spain's La Liga</h2>
		<h3 class='authors'>Peter Xenopoulos, Stefan Cherubin</h3>

		<br>

		<p>Spain's La Liga is one of the most popular soccer leagues in the world, hosting both perennial giants Barcelona and Real Madrid, as well as more recent contenders such as Atletico Madrid. These three teams have occupied the top 3 positions since the 2012-2013 season. Additionally, at least one of Barcelona or Real Madrid has finished in the top 3 since the 1969-1970 season. Since the 1970-1971 season, just 9 clubs have won the league, which is less than half of all the clubs currently in the league (20), with either Barcelona or Real Madrid winning the league 75 percent during that time frame. </p>
		
		<p>We define competition in a given season as a function of the variation in the points scored by each team. If you hover over one of the seasons, you can see a bar chart illustrating the difference in average points per match. In season where competition is lower, we see big differences between the top and the bottom of the league. A low competition season will have the league leaders and worst teams incredibly far apart. In seasons with lots of competition, the difference shrinks, and the distribution will look more uniform.</p>

		</div>
		<h2>Competition in La Liga since 1970</h2>
					<div class = "mainView">
				<div class="competitive">
					<svg id ="compEvents"></svg>
				 </div>
					<div class ='compline'>
							<div class ='ppm'>
									<svg id ="ppmchart"></svg>
							</div>
							<div id = "scatter">
									<svg id ="scatterplot"></svg>
			
							</div>
					</div>
				
				
			</div>
		<p>It's clear that the league is becoming drastically less competitive, especially in the last decade, however the general trend seems to have started in the early 2000s, when TV contracts were renegotiated. Recent regulations and financial crisis seemed to have maintained the inequality status quo.</p>
		<br />
		<br />
		<div class = "banner_mid"></div>
		<h2>Event Descriptions</h2>
		<p>
			Here are deeper descriptions of the five events we cover in our visualization. 
				<ul>
					<li><b>Bosman Ruling (1995)</b> - This EU wide ruling banned restrictions mandating a transfer fee be paid for players at the end of their contract. Essentially, players were more free to move from club to club.</li>
					<li><b>Rise of Digital TV (1996)</b> - Before 1996, La Liga TV deals were negotiated as a league, and there was parity among teams. In 1996, digital TV took hold and clubs negotiated those contracts independently.</li>
					<li><b>End of Initial TV Deals (2001)</b> - Typically, TV contracts last anywhere between 3 and 5 years. As the value of teams was now more easily known, La Liga TV rights started to become uneven and skewed towards Real Madrid and Barcelona.</li>
					<li><b>Spain's Financial Crisis (2008)</b> - This is the generally accepted starting year of Spain's recession, which lasted from 2008 to 2014.</li>
					<li><b>UEFA Financial Fair Play Rules (2011)</b> - Although agreed in principal in 2009, UEFA's financial fair play rules, which cap club financial losses, were instituted at the start of the 2011-2012 season.
				</ul>
		</p>
		<h2>Competition Metric</h2>
		<p> We introduce a metric for competitiveness which relies on the variation in the points per match for each season. We do this for two reasons: (1) we must use per match metrics, as the number of teams in the league has varied between more recent and older seasons and (2) the more variation there is in points per match, the more we have really "good" teams and really "bad" teams. A lower competitiveness metric means that the team had more variation between teams. We see that in general, the trend has been that competitiveness has decreased for the last decade and a half. Specifically, our competition metric for a given season is defined as
		<br />
		<br />
		<img src='competitiveness_calc.gif' alt='calculating competitiveness'/>
		<br />
		<br /> </p>
	</div>
	<script>
			var margin = {
			top: 30,
			right: 20,
			bottom: 30,
			left: 150
		  };
		var width = 750 - margin.left - margin.right;
		var height = 400 - margin.top - margin.bottom;

		var svg = d3.select("#titles")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			  .append("g")
			.attr("transform", "translate(" + margin.left + "," +  margin.top + ")")
			.attr("align", "bottom");

		var x = d3.scaleLinear()
			  .range([0, width]);

		var y = d3.scaleBand()
			.range([height, 0]);

		var xAxis = d3.axisBottom(x)
			//.tickValues([1, 2, 4, 18, 21]);

		var yAxis = d3.axisLeft(y);

			var parseTime = d3.timeParse("%Y");

			var xValue = function(d){ return d.season; };

			var axisXLine = d3.scaleLinear()
				//.domain(d3.extent(data, d => d.season))
				.range([0,width]);

			var XAxis = d3.axisBottom(axisXLine).tickFormat(d3.format("d"));

			var yValue = function(d){return d.comp; };

			var axisYLine = d3.scaleLinear()
				.range([height, 0]);

			var YAxis = d3.axisLeft(axisYLine);

			var tooltip = d3.select("body").append("div")
			.attr("class", "tooltip")
			.style("opacity", 0);

			var compBody = d3.select("#comp")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

			var valueline = d3.line()
				.x(d => axisXLine(d.season))
				.y(d => axisYLine(d.comp));

			var g = compBody.append("g");

			d3.tsv("results.tsv", type, function(err, data){
                    if (err) throw err;
                    
                columns = []

            

				

				data.forEach(function(d){
					d.season = d.season,
					d.club = d.club,
                    d.ppm = +d.ppm

                    if (columns.indexOf(d.club) < 0 ){
                        columns.push(d.club)
                    }
					

                });

			
                
                var season = "season"
                var ppm = ""
                var xLabel = "Year"
                var yLabel = "Points Per Match"


                var scattersvg = d3.select("#scatterplot")
                .attr("width",  1000 + width + margin.left + margin.right)
                .attr("height", 1000 + height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var xValue = (d) => {
                    return d.season
                }

                var xScale = d3.scaleLinear()
                .range([0, width * 2.5])
                .domain([1969,2018])

                var xMap = (d) => {
                    return xScale(xValue(d))
                }

                var axisX = d3.axisBottom(xScale).ticks(40)

                var yScale = d3.scaleLinear()
                .range([height * 2, 0])
                .domain([0,3.0])


                for(var i=0;i<columns.length;i++) {
                    var y=columns[i];
                    var yValue = function(d) { return d.ppm;}
                    //yScale = d3.scalelinear().range([height, 0]),
                    var yMap = function(d) { return yScale(yValue(d));}
                    var axisY = d3.axisLeft(yScale).ticks(20)
                   // var yAxis = d3.svg.axis().scale(yScale).orient("left")
                    data.forEach(function(d) {
                        d[x] = d.season;
                        d[y] = +d.ppm;
                    });

					let averageppm = d3.mean(data, (d) => d.ppm)
					let stddev = 0.923684;
                   // yScale.domain([d3.min(data, yValue)-0.2, d3.max(data, yValue)+0.2]);
                    scattersvg.selectAll(".dot"+i)
                        .data(data)
                        .enter()
                        .append("circle")
                        .attr("class", "ndot"+i)
                        .attr("data-legend",function(d) { return d.club}) //optional legend
                        .style("fill", function(d){

							if (d.club === "Barcelona"){
								//return "#ADEC43"
								return "#2E1A28"
							}
							if (d.club === "Real Madrid"){
								return "ghostwhite"
							}
							if (d.ppm >= 0.5 * stddev + averageppm){
								return "#1E694D"
							}
							if ( d.ppm < averageppm -  0.5 * stddev){
								return "#EE855C"
							}
							
							//return "#5596e6"
						})
                        //.style("stroke", "black")
                        .attr("r", 3.75)
                        .attr("cx", xMap)
                        .attr("cy", yMap)
						.on("mouseover", function(d) {
					//compSecondary(data, xValue(d))
					tooltip.transition()
						 .duration(200)
						 .style("opacity", 1.0);
						 tooltip.html("Club: " + d.club  + "<br/> " + "Competitiveness: " + yValue(d)   )
						 .style("left", (d3.event.pageX + 5) + "px")
						 .style("top", (d3.event.pageY - 28) + "px");
						 
				})
				.on("mouseout", function(d) {
					tooltip.transition()
						 .duration(500)
						 .style("opacity", 0);
				})
                }

                scattersvg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height * 2 + ")")
                .call(axisX.tickFormat(d3.format("d")))
                .append("text")
                .attr("y", -5)
                .attr("x", width)
                .style("text-anchor", "end")
                .style("fill","#333333")
                .style("font-size","15px").text(xLabel);

                scattersvg.append("g")
                .attr("class", "y axis")
                .call(axisY)
                .append("text")
                .attr("transform", "translate(" + -25 + ",0)")
                .attr("y", 6)
                .style("text-anchor", "end")
                .style("fill","#333333")
                .style("font-size","15px").text(yLabel);

				let colorList = ["Barcelona", "Real Madrid",  "Significantly Above Average PPM","Within Average PPM", "Significantly Below Average PPM"]
				var color = d3.scaleOrdinal()
				.domain(colorList)
				.range(["#2E1A28", "ghostwhite",  "#1E694D","#81822F", "#EE855C"]) 	

				 var legend = scattersvg.selectAll(".legend")
				.data(color.domain())
				.enter().append("g")
				.attr("class", "legend")
				.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

			// draw legend colored rectangles
			legend.append("rect")
				.attr("x", width - 18)
				//.attr("class", "ndot51")
				.attr("width", 18)
				.attr("height", 18)
				//.attr("r", 3.5)
				.style("stroke", "black")
				.style("fill", color);

			// draw legend text
			legend.append("text")
				.attr("x", width - 24)
				.attr("y", 9)
				.attr("dy", ".35em")
				.style("text-anchor", "end")
				.text(function(d) { return d;})


				
			
				

        


                })


//			

///----------------------------------
			function compSecondary(data, year){
				d3.tsv("results.tsv", type, function(err, data){
					if (err) throw err;

				data.forEach(function(d){
					d.season = d.season,
					d.club = d.club,
					d.ppm = +d.ppm
				});

				data = data.filter(function(d){
					return d.season == year
				})

				var resultsX = x.domain([0,3.0]);

				var resultsY = y.domain(data.map(function(d) { return d.club; }))
				.padding(0.2)
				

				var ppmsvg = d3.select("#ppmchart")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
				
				ppmsvg.append("g")
				.attr("class", "y axis")
				.call(yAxis)
				.append("text")
				.attr("class", "label")
				.attr("transform", "translate(" + 10 + ",0)")
				.attr("x", 0)
				.style("text-anchor", "end")
				.text("Club");

				ppmsvg.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(d3.axisBottom(resultsX))
				.append("text")
				.attr("class", "label")
				.attr("transform", "translate(" + width + ",0)")
				.attr("y", -5)
				.style("text-anchor", "end")
				.text("Points Per Match");

		
			  ppmsvg.selectAll(".bar")
			  .data(data)
			  .enter().append("rect")
			  .attr("class", "bar")
			  .attr("x", 0)
			  .attr("height", resultsY.bandwidth())
			  .attr("y", function(d) { return y(d.club); })
			  .attr("width", function(d) { return resultsX(d.ppm); })






				})
			}

		

			d3.tsv("competitive_measures.tsv", type, function(err, data){
				if (err) throw err;

				//compSecondary(data, 2005)

				data.forEach(function(d){
					d.season = d.season,
					d.comp = +d.comp
				});
				

				


				//var maxComp = d3.max(data, d => d.comp);
				axisXLine.domain(d3.extent(data, function(d) {return d.season;}));


				//.domain([0,maxComp]);
				axisYLine.domain([0, d3.max(data, function(d) {return d.comp;})]);



				compBody.append("g")
				.attr("class", "y axis")
				.call(YAxis)
				.append("text")
				.attr("class", "label")
				.attr("transform", "translate(" + -15 + ",0)")
				.attr("x", 0)
				.style("text-anchor", "end")
				.text("Competitiveness");

				compBody.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(XAxis)
				.append("text")
				.attr("class", "label")
				.attr("transform", "translate(" + width + ",0)")
				.attr("y", -5)
				.style("text-anchor", "end")
				.text("Season");


				compBody.append("path")
				.datum(data)
				.attr("class", "line")
				.attr("d", valueline)
				.attr("x", function(d) { return axisXLine(d.season); })
				.attr("y", function(d) { return axisYLine(d.comp); });
				//.attr("width", function(d) { return x(d.season); });

				var lineAndDots = g.append("g")
				.attr("class", "line-and-dots");
				//.attr("transform", "translate(" + ((margin.left + margin.right) / 2) + "," + 0 + ")");


				lineAndDots.selectAll(".dot").data(data)
				.enter().append("circle")
				.attr("class", "dot")
				.attr("r", 4)
				.attr("cx", function(d) { return axisXLine(d.season); })
				.attr("cy", function(d) { return axisYLine(d.comp); })
				.on("mouseover", function(d) {
					//compSecondary(data, xValue(d))
					tooltip.transition()
						 .duration(200)
						 .style("opacity", 1.0);
						 tooltip.html("Year: " + xValue(d)  + "<br/> " + "Competitiveness: " + yValue(d)   )
						 .style("left", (d3.event.pageX + 5) + "px")
						 .style("top", (d3.event.pageY - 28) + "px");
						 
				})
				.on("mouseout", function(d) {
					tooltip.transition()
						 .duration(500)
						 .style("opacity", 0);
				})
				

			});

			var compBodyEvents = d3.select("#compEvents")
			  .attr("width", width + margin.left + margin.right)
			  .attr("height", height + margin.top + margin.bottom)
			  .append("g")
			  .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
			  

			var valueline = d3.line()
			  .x(d => axisXLine(d.season))
			  .y(d => axisYLine(d.comp));

			var g = compBodyEvents.append("g");

			d3.tsv("competitive_measures.tsv", type, function(err, data){
			  if (err) throw err;

			  data.forEach(function(d){
			    d.season = d.season,
			    d.comp = +d.comp
			  });


			  //var maxComp = d3.max(data, d => d.comp);
			  axisXLine.domain(d3.extent(data, function(d) {return d.season;}));


			  //.domain([0,maxComp]);
			  axisYLine.domain([0, d3.max(data, function(d) {return d.comp;})]);



			  compBodyEvents.append("g")
			  .attr("class", "y axis")
			  .call(YAxis)
			  .append("text")
			  .attr("class", "label")
			  .attr("transform", "translate(" + -15 + ",0)")
			  .attr("x", 0)
			  .style("text-anchor", "end")
			  .text("Competitiveness");

			  compBodyEvents.append("g")
			  .attr("class", "x axis")
			  .attr("transform", "translate(0," + height + ")")
			  .call(XAxis)
			  .append("text")
			  .attr("class", "label")
			  .attr("transform", "translate(" + width + ",0)")
			  .attr("y", -5)
			  .style("text-anchor", "end")
			  .text("Season");

			  compBodyEvents.append("path")
			  .datum(data)
			  .attr("class", "line")
			  .attr("d", valueline)
			  .attr("x", function(d) { return axisXLine(d.season); })
			  .attr("y", function(d) { return axisYLine(d.comp); });
			  //.attr("width", function(d) { return x(d.season); });

				g.append("line")
				.attr("x1", axisXLine(1995))
				.attr("y1", 0.00)
				.attr("x2", axisXLine(1995))
				.attr("y2", 340)
				.style("stroke-width",2)
				.style("stroke", "#5596e6")
				.style("fill", "none")
				.on("mouseover", function(d) {
					tooltip.transition()
						 .duration(200)
						 .style("opacity", 1.0);
						 tooltip.html("<b>Bosman Ruling (1995)</b>" + "<br /> <br />" + "<i>Players are more free to change clubs without transfer fees. Competition <b>neutral</b>.</i>")
						 .style("left", (d3.event.pageX + 5) + "px")
						 .style("top", (d3.event.pageY - 28) + "px");
				})
				.on("mouseout", function(d) {
					tooltip.transition()
						 .duration(500)
						 .style("opacity", 0);
				});

				g.append("line")
				.attr("x1", axisXLine(1996))
				.attr("y1", 0.00)
				.attr("x2", axisXLine(1996))
				.attr("y2", 340)
				.style("stroke-width",2)
				.style("stroke", "#5596e6")
				.style("fill", "none")
				.on("mouseover", function(d) {
					tooltip.transition()
						 .duration(200)
						 .style("opacity", 1.0);
						 tooltip.html("<b>First Major TV Deals (1996)</b>" + "<br /> <br />" + "<i>There is a major increase to revenues for all La Liga clubs. Competition <b>increases</b>.</i>")
						 .style("left", (d3.event.pageX + 5) + "px")
						 .style("top", (d3.event.pageY - 28) + "px");
				})
				.on("mouseout", function(d) {
					tooltip.transition()
						 .duration(500)
						 .style("opacity", 0);
				});

				g.append("line")
				.attr("x1", axisXLine(2001))
				.attr("y1", 0.00)
				.attr("x2", axisXLine(2001))
				.attr("y2", 340)
				.style("stroke-width",2)
				.style("stroke", "#5596e6")
				.style("fill", "none")
				.on("mouseover", function(d) {
			    tooltip.transition()
			       .duration(200)
			       .style("opacity", 1.0);
			       tooltip.html("<b>End of First Major TV Deals (2001)</b>" + "<br /> <br />" + "<i>Real Madrid and Barcelona swoop in to control the vast majority of TV revenue. Competition <b>decreases</b>.</i>")
			       .style("left", (d3.event.pageX + 5) + "px")
			       .style("top", (d3.event.pageY - 28) + "px");
			  })
				.on("mouseout", function(d) {
			    tooltip.transition()
			       .duration(500)
			       .style("opacity", 0);
			  });

				g.append("line")
				.attr("x1", axisXLine(2008))
				.attr("y1", 0.00)
				.attr("x2", axisXLine(2008))
				.attr("y2", 340)
				.style("stroke-width",2)
				.style("stroke", "#5596e6")
				.style("fill", "none")
				.on("mouseover", function(d) {
			    tooltip.transition()
			       .duration(200)
			       .style("opacity", 1.0);
			       tooltip.html("<b>Spain's Financial Crisis (2008)</b>" + "<br /> <br />" + "<i>Spain enters recession and some clubs fail to meet debt obligations. Competition <b>decreases</b>.</i>")
			       .style("left", (d3.event.pageX + 5) + "px")
			       .style("top", (d3.event.pageY - 28) + "px");
			  })
				.on("mouseout", function(d) {
			    tooltip.transition()
			       .duration(500)
			       .style("opacity", 0);
			  });

				g.append("line")
				.attr("x1", axisXLine(2011))
				.attr("y1", 0.00)
				.attr("x2", axisXLine(2011))
				.attr("y2", 340)
				.style("stroke-width",2)
				.style("stroke", "#5596e6")
				.style("fill", "none")
				.on("mouseover", function(d) {
			    tooltip.transition()
			       .duration(200)
			       .style("opacity", 1.0);
			       tooltip.html("<b>UEFA Financial Fair Play (2011)</b>" + "<br /> <br />" + "<i>UEFA enacts financial fair play rules, essentially maintaining the status quo of the league. Competition <b>decreases</b>.</i>")
			       .style("left", (d3.event.pageX + 5) + "px")
			       .style("top", (d3.event.pageY - 28) + "px");
			  })
				.on("mouseout", function(d) {
			    tooltip.transition()
			       .duration(500)
			       .style("opacity", 0);
			  });

			  var lineAndDots = g.append("g")
			  .attr("class", "line-and-dots");
			  //.attr("transform", "translate(" + ((margin.left + margin.right) / 2) + "," + 0 + ")");


			  lineAndDots.selectAll(".dot").data(data)
			  .enter().append("circle")
			  .attr("class", "dot")
			  .attr("r", 4)
			  .attr("cx", function(d) { return axisXLine(d.season); })
			  .attr("cy", function(d) { return axisYLine(d.comp); })
			  .on("mouseover", function(d) {
				  
			    tooltip.transition()
			       .duration(200)
			       .style("opacity", 1.0);
			       tooltip.html("Year: " + xValue(d)  + "<br/> " + "Competitiveness: " + yValue(d)   )
			       .style("left", (d3.event.pageX + 5) + "px")
			       .style("top", (d3.event.pageY - 28) + "px");

			    if (!d3.select("#ppmchart").empty()){
					d3.select("#ppmchart").selectAll("g > *").remove()
				}
				
				compSecondary(data, xValue(d));
			  })
			  .on("mouseout", function(d) {
			    tooltip.transition()
			       .duration(500)
			       .style("opacity", 0);
			  })

			});

		function type(d) {
		  d.titles = +d.titles;
		  return d;
		}
			</script>
			

</body>
</html>
